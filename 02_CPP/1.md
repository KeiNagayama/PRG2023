# C++入門（数値シミュレーション向け）

Pythonの基本構文を理解した上で，数値シミュレーション用にC++を学習したい方向け．

## 数値シミュレーションとは

数値シミュレーションとは，現実のシステムやプロセスを模倣してルールを定義し，コンピュータ上で実行することで，そのふるまいや性質を予測したり分析したりするために使います．日常的にお世話になっている天気予報は，大気や海洋・陸地の状態を物理方程式に従ってコンピュータ上で時間変化させ，将来の状態を予測しています．

参考：気象庁, 数値予報とは <https://www.jma.go.jp/jma/kishou/know/whitep/1-3-1.html>

シミュレーションは決定論的なものと確率論的なものに分類できます（単に決定的，確率的ともいう）．

- **決定論的シミュレーション**: 状態の変化が直前の状態によって完全に決定されるもの．初期値とパラメータが決まれば，状態の変化は常に同じ．
- **確率論的シミュレーション**: 状態の変化が確率的に決定されるもの．サイコロの出た目によって行動を変えるようなシミュレーションがこれに当たります．

高安研究室で使われているシミュレーションの例を紹介します．

1. **ディーラーモデル**
    金融市場に参加するディーラーたちの戦略を定義し，マクロな現象として観測される暴騰・暴落などの金融市場価格の動的なふるまいとの関係を探る．順張り・逆張り戦略取るディーラーの比率を変えたり，利益確定や損切りの閾値を変えたり，政府による為替介入を導入できたりと，発展性が高い．

    - Yamada, Kenta, Hideki Takayasu, Takatoshi Ito, and Misako Takayasu. 2009. “Solvable Stochastic Dealer Models for Financial Markets.” Physical Review. E, Statistical, Nonlinear, and Soft Matter Physics 79 (5 Pt 1): 051120. <http://dx.doi.org/10.1103/PhysRevE.79.051120>
    - 松永健太, 山田健太, 高安秀樹, and 高安美佐子. 2012. “スプレッドディーラーモデルの構築とその応用.” 人工知能学会論文誌 27 (6): 365–75. <http://dx.doi.org/10.1527/tjsai.27.365>

2. **企業間取引ネットワークの時間発展モデル**
    新規参入する企業がどのような規模の企業と取引を開始するのか，どのような企業が合併・分社するのか，どのような企業が倒産するのかを調べ，マクロな性質である売上高や成長率，寿命の分布などを再現する．

    - Miura, Wataru, Hideki Takayasu, and Misako Takayasu. 2012. “Effect of Coagulation of Nodes in an Evolving Complex Network.” Physical Review Letters 108 (16): 168701. <http://dx.doi.org/10.1103/PhysRevLett.108.168701>
    - Ozaki, Jun ’ichi, Eduardo Viegas, Hideki Takayasu, and Misako Takayasu. 2024. “Integration of B-to-B Trade Network Models of Structural Evolution and Monetary Flows Reproducing All Major Empirical Laws.” Scientific Reports 14 (1): 4628. <http://dx.doi.org/10.1038/s41598-024-54719-0>

## C++とは

![](ISO_C++_Logo.pn)

1983年に開発されたコンパイル言語であり，データ解析の現場では重たい計算を回す際に使われています．C++はC言語の拡張であり，クラスや継承などのオブジェクト指向プログラミングの機能が追加されたほか，基本的なデータ構造やアルゴリズムが標準テンプレートライブラリ(STL)にまとめられ，追加されました．Pythonから入った方には驚かれるかもしれませんが，C言語にはこれらの機能が備わっておらず，基本的にはすべて自前で実装する必要がありました．C++ではSTLを活用することで実装コストを抑えつつ，高速に動作するプログラムを作ることができます．

C++の強みと弱み

- 強み：適当に書いても速い
- 弱み：ファイル操作や図の作成には向かない

C++の強みを活かし，弱みを補うために，以下のように作業を仕分けることが多い．

- AwkなどのUNIXコマンド: データ抽出
- Python: 基本的な解析と図表作成
- C++: シミュレーション等の重たい計算

## C++で覚えること

1. 基本
    - C++の使い方：コンパイルと実行方法
    - 基本型：bool, char, int, double, void
    - 関数：定義，関数呼び出し
    - 制御文：if, for, while, switch
    - コマンドライン引数：argc, argv

2. STLの使い方
    - 文字列：文字列型と数値型の相互変換
    - 入出力：標準入出力，ファイル入出力
    - コンテナ：vector, map, set, queue, stack, pair, tuple
    - 数値計算：cmath, random
    - アルゴリズム：sort, unique, reverse

3. シミュレーションの実装
    - ディーラーモデル
    - ネットワークの成長モデル（Barabashi-Albert model）

C++を網羅的に学習したい方は下記のサイト等を利用できます．一般向けのC++入門は，大規模開発に使うことを想定してオブジェクト指向プログラミングの機能の解説に重点を置いています．シミュレーションに必要な機能はそれよりもずっとシンプルですので，時間をかけて目を通す必要はありません．

- ゼロから学ぶC++ <https://rinatz.github.io/cpp-book/>
- 一週間で身に付くC++言語の基本 <https://cpp-lang.sevendays-study.com>

## Part1: 基本

Visual Studio Code をお使いなら，拡張機能 [C/C++](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools) を入れておくと良いでしょう．IntelliSense という入力支援機能が入っており，プログラミングが楽になります．

### Hello world

プログラミング言語入門の慣例にならって，まずは Hello world! を出力してみましょう．

C++ファイルの拡張子には `cpp` を使います．Visual Studio Code などの適当なエディタ上で `hello.cpp` というファイルを作成し，下記のようなソースコードを作ります．

```c++
#include <iostream>

int main() // プログラムを実行すると最初に呼び出される
{
    std::cout << "Hello world!" << std::endl; // ターミナルに Hello world! と出力
    return 0; // プログラムが正常に終了したことを表す
}
```

- `#include <iostream>`, `std::cout`, `std::endl` はおまじないだと思って流してください．STLの標準入出力の節で解説します．
- `main()` はプログラムの実行開始点で，プログラムが実行されると最初に呼び出されます．
- `{}`で囲まれた部分が一つのブロックです．Pythonではインデントが一つのブロックになっています．
- 文の終わりにはセミコロン`;`を付けます．文(statement)とは，プログラムの概念です．[こちら (wikipedia)](https://w.wiki/9Yee) をご参照ください．
- `return 0` は，`main` 関数の最後に記述することで，プログラムが正常に終了したことをオペレーティングシステムに伝える役割があります．途中でエラーが発生した場合には 0 以外の数値が返されます．最初のうちはこの意味に深くこだわらなくても大丈夫で，`main` 関数の最後に記述するということだけ覚えておけば十分です．
- コメントアウトするには `//` を前に付けるか，`/* */` で囲います．

続いて，`hello.cpp` を**コンパイル**します．コンパイルとは，人間が書いたプログラムをコンピュータが理解できる機械語（バイナリコード）に変換することです．この変換を行なうプログラムをコンパイラと言います．

```sh
$ g++ -std=c++17 hello.cpp
```

- `g++` はC++のコンパイラの一つで，LinuxやUNIX系のシステムで広く使われています．
- `-std=c++17` ではC++のバージョンを指定しています．17は2017年に対応していて，他に `c++11,c++14,c++20` などがあります．2011年以降は3年ごとに更新され，その度に便利な機能が追加されています．

コンパイルすると，コンパイラによって `a.out` というファイルが作られます．これは**実行ファイル**と呼ばれ，ターミナル上で下記のようにファイル名を入力すると，プログラムが実行されます．

```sh
$ ./a.out
Hello world!
```

- `./` は現在のディレクトリを指します．
- `g++` に `-o name` のオプションをつけることで，実行ファイルに名前をつけることができます．この際，実行ファイルには拡張子を付けないことが多いです．

```sh
$ g++ -std=c++17 hello.cpp -o hello 
$ ./hello
Hello world!
```

`g++` に渡すオプションやファイル名の順番は，一部のケースを除いて通常は関係ありません．例えば，以下の2つのコマンドは同じ結果をもたらします．

```sh
$ g++ -std=c++17 hello.cpp -o hello
$ g++ hello.cpp -o hello -std=c++17
```

`g++` には他にもいくつかオプションがあります．代表的なものには以下の2つがあります．

- `-Wall` : 通常よりも多くの警告メッセージを出す．
- `-O1, -O2, -O3` : 最適化オプション．数字が大きいほど最適化レベルが高い．

---

以下は実行ファイルの中身が気になる人に向けた補足（蛇足）です．読み飛ばして構いません．

`hexdump` コマンドを使うと実行ファイルの中身を読むことができます．試しに実行ファイル `hello` のうち，`Hello world!` に対応する部分の周辺を見てみたのが以下です．

```sh
$ hexdump -C hello | grep -B3 -A3 Hello
00003f10  c0 03 5f d6 10 00 00 b0  10 02 40 f9 00 02 1f d6  |.._.......@.....|
00003f20  10 00 00 b0 10 06 40 f9  00 02 1f d6 10 00 00 b0  |......@.........|
00003f30  10 16 40 f9 00 02 1f d6  10 00 00 b0 10 1a 40 f9  |..@...........@.|
00003f40  00 02 1f d6 00 3f 00 00  48 65 6c 6c 6f 20 77 6f  |.....?..Hello wo|
00003f50  72 6c 64 21 00 01 01 01  14 00 00 00 00 00 00 00  |rld!............|
00003f60  01 7a 52 00 01 78 1e 01  10 0c 1f 00 00 00 00 00  |.zR..x..........|
00003f70  2c 00 00 00 1c 00 00 00  18 ff ff ff ff ff ff ff  |,...............|
```

- 左の列はメモリのアドレス（データが格納されている場所を指す一意の番号）
- 中央の1バイト区切りの数字の羅列は指定されたアドレスに記述された命令
- 右の列は命令をASCII文字に無理やり変換したもの

もし機械語に興味が出てきたら wikipedia (<https://w.wiki/9XL7>) 等を参照ください．

---

### 基本型

#### 数値型

- `int`: 整数を表す．4バイト．取りうる値の範囲は -2,147,483,648 ~ 2,147,483,647
- `double`: 倍精度浮動小数点．8バイト．

オーダー $10^6$ を超える整数を扱いたい場合は，8バイトの整数型である `long` を使います．浮動小数型には `float` 型（4バイト）もあります．計算精度が落ちますので，**C++ で数値計算を行なう場合には `float` 型は絶対に使わないでください．**
特に，Pythonに慣れている人は要注意です．Pythonの `float` 型は8バイトの浮動小数点で，C++や他の言語の `double` 型に該当します．

他の言語と同様に，加減乗除・剰余演算が定義されています．除算と剰余には注意点があります．

- 除算：`int` 型同士の割り算では端数が切り捨てられ，`int` 型になります．マイナスの数は0に近づくように丸められます．
- 剰余：マイナスの数を含む剰余の符号は割られる数の符号と一致するように定義されています．

```c++
// 変数の宣言（型宣言が必要）
int year = 2024;
double USD_TO_JPY = 151.42; // at 2024.03.23

// 除算（整数は切り捨て）
std::cout << 2 / 3 << std::endl;    // 0
std::cout << -2 / 3 << std::endl;   // 0
std::cout << 2.0 / 3 << std::endl;  // 0.666667
std::cout << -2 / 3.0 << std::endl; // -0.666667

// 剰余（符号は割られる数の符号と一致）
std::cout << 2 % 3 << std::endl;   //  2
std::cout << 2 % -3 << std::endl;  //  2
std::cout << -2 % 3 << std::endl;  // -2
std::cout << -2 % -3 << std::endl; // -2
```

また，整数型 `int` にはインクリメント `++`，デクリメント `--` が定義されています．

- `++i` のように変数の前に付けると，インクリメントしてから，その値が使われます．
- `i++` のように変数の後に付けると，値を使ってから，インクリメントされます．

下記のように，単体で使う分には同じ結果になります．

```c++
++i;
i++;
```

本稿では `++i` をメインに使っていきます．これは，頻繁に利用する下記のようなドキュメントの流儀に合わせ，書き写した場合にも一貫性が保たれるようにするためです．

- [C++ 日本語リファレンス](https://cpprefjp.github.io)
- [手を動かしてさくさく理解する C言語/C++ プログラミング入門](http://vivi.dyndns.org/tech/cpp/cpp.html)

> `++i` と `i++` のどちらが速いか等の記事が散見されますが，もし速度に差があったとしても，そこに拘った時間以上に時間が生み出されることはありません．研究成果に繋がらないことに時間を割くことは慎まれるように．もちろん，趣味の時間をお使いになる分には一向に構いません．

インクリメントした値を使う場合には結果が変わります．

```c++
int a = 0;
int b; // 宣言だけして初期化しない

b = ++a; // aをインクリメントしてからbに代入
// a = 1, b = 1

b = a++; // aをbに代入してからaをインクリメント
// a = 2, b = 1
```

ただし，このようなインクリメントの使い方は紛らわしく，バグの温床になります．**研究でのプログラミングで最も重要なことは「正確さ」です．正確に書くために，次点として「理解しやすさ」が重要になります．** 上の処理は，次のように書くと手順がはっきりして理解しやすくなります．また，`++a` と `a++` のどちらを使っても結果が変わらないので，バグの心配もいりません．

```c++
int a = 0;
int b; // 宣言だけして初期化しない

++a;   // aをインクリメント (a++でも結果は同じ)
b = a; // bに代入
// a = 1, b = 1

b = a; // bに代入
++a;   // aをインクリメント (a++でも結果は同じ)
// a = 2, b = 1
```

#### 真偽値型 `bool`

- `true`, `false`の2値を取る
- 否定・AND・OR演算が定義されている

```c++
bool A = true;
bool B = false;
bool not_A = !A;       // false
bool A_and_B = A && B; // false
bool A_or_B = A || B;  // true

// 出力時は true→1, false→0 と置き換えられる
std::cout << not_A << std::endl;   // 0
std::cout << A_and_B << std::endl; // 0
std::cout << A_or_B << std::endl;  // 1
```

#### 文字列 `char`

- 1バイトのASCII文字を表す
- **シングルクオーテーション**で囲む
- 区切り文字 (delimiter) の指定などに使う

```c++
char delim = ','; // カンマ区切り
delim = ' ';      // スペース区切り
delim = '\n';     // 行単位で区切る
```

文字列型 `string` は基本型には含まれていません．C言語ではchar配列として文字列を定義していましたが，C++ではSTLに `string` が追加されました．`string` の使い方は STLの章で説明します．

### 制御文

- 条件分岐：`if`, `switch`
- ループ：`for`, `while`
- ループの中断：`continue`, `break`

これらの使用例を見る前に，**ブロック**

同じ条件下で複数行に渡る処理を書きたい場合は `{}` が必要です．

次の4つの `if` 文はまったく同じです．

```c++
if (true) /* 一行の処理 */

if (true) 
    /* 一行の処理 */

if (true){
    /* 一行以上の処理 */
}

if (true)
{
    /* 一行以上の処理 */
}
```


```c++
for (int i = 0; i < 4; i++)
{
    if (i / 2 == 0) continue; // 偶数をスキップ
    std::cout << i << std::endl;
}
// 出力
1
3

for (int i = 0; i < 4; i++)
{
    if (i / 2 == 0) break; // 偶数をスキップ
    std::cout << i << std::endl;
}
// 出力
1
3
```

### 関数

- 宣言：`戻り値型 関数名(型 引数名)`
- 引数にはデフォルト値を指定できます `戻り値型 関数名(型 引数名=デフォルト値)`

```c++
// べき乗を計算（ただし，底は非負整数，指数は整数）
int power(int base, int exponent)
{
    if (exponent == 0) return 1;
    return base * power(base, exponent - 1);
}

// "="の仕切りを標準出力
void print_partition(int length = 30)
{
    for (int i = 0; i < length; i++)
    {
        std::cout << '=';
    }
    std::cout << std::endl;
}
```

`{}` の中身が一行しかない場合は `{}` を省いても大丈夫です．

```c++
// ** オーバーフローに注意 **
// power(10, 9)  = 1000000000
// power(10, 10) = 1410065408
```

## Part2: STLの使い方

## Part3: シミュレーションの実装
